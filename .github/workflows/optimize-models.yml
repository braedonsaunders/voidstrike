name: Optimize 3D Models

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  optimize:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install gltfpack
        run: |
          echo "üéÆ Installing gltfpack..."
          wget -q https://github.com/zeux/meshoptimizer/releases/download/v1.0/gltfpack-ubuntu.zip
          unzip -q gltfpack-ubuntu.zip
          chmod +x gltfpack
          sudo mv gltfpack /usr/local/bin/

      - name: Optimize models
        run: |
          echo "üì¶ Optimizing models..."

          # Create/load optimized files registry
          REGISTRY=".github/optimized-models.txt"
          touch "$REGISTRY"

          files=$(find public/models -name "*.glb" -type f)
          optimized_count=0

          for file in $files; do
            # Get file hash to check if already optimized
            file_hash=$(sha256sum "$file" | cut -d' ' -f1)

            # Skip if already optimized (hash exists in registry)
            if grep -q "$file_hash" "$REGISTRY" 2>/dev/null; then
              echo "‚è≠Ô∏è  Skipping (already optimized): $file"
              continue
            fi

            echo "Processing: $file"
            original_size=$(stat -c%s "$file")
            echo "  Original size: $((original_size / 1024)) KB"

            # Run gltfpack with texture compression
            temp_file="${file}.optimized.glb"
            if gltfpack -i "$file" -o "$temp_file" -cc 2>&1; then
              opt_size=$(stat -c%s "$temp_file")
              echo "  Optimized size: $((opt_size / 1024)) KB"

              # Only replace if we got meaningful compression and file is valid
              if [ $opt_size -gt 100000 ] && [ $opt_size -lt $original_size ]; then
                mv "$temp_file" "$file"
                reduction=$((100 - (opt_size * 100 / original_size)))
                echo "  ‚úÖ Saved ${reduction}% ($((original_size / 1024)) KB ‚Üí $((opt_size / 1024)) KB)"

                # Add new hash to registry
                new_hash=$(sha256sum "$file" | cut -d' ' -f1)
                echo "$new_hash  $file" >> "$REGISTRY"
                optimized_count=$((optimized_count + 1))
              else
                echo "  ‚ö†Ô∏è Optimization didn't help, keeping original"
                rm -f "$temp_file"
                # Still mark as processed so we don't retry
                echo "$file_hash  $file" >> "$REGISTRY"
              fi
            else
              echo "  ‚ö†Ô∏è gltfpack failed, keeping original"
              rm -f "$temp_file"
            fi
          done

          echo ""
          echo "üìä Optimized $optimized_count model(s)"

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add optimized models and registry
          git add public/models/**/*.glb .github/optimized-models.txt

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit (models already optimized)"
          else
            git commit -m "chore: Optimize 3D models (gltfpack)"
            git push
          fi
